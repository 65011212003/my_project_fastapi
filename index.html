<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบวิเคราะห์โรคข้าว</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/antd@4.24.15/dist/antd.min.css">
    <script src="https://cdn.jsdelivr.net/npm/antd@4.24.15/dist/antd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ant-design/icons@4.8.0/dist/index.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- Add Thai font -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/flag-icon-css@3.5.0/css/flag-icon.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background: url('https://t4.ftcdn.net/jpg/02/70/12/65/360_F_270126543_Fpjy5Y3I0JHGOazU5UxKZxG3hMXv7ixC.jpg') no-repeat center center fixed;
            background-size: cover;
            min-height: 100vh;
        }

        .gradient-header {
            background: linear-gradient(90deg, #4CAF50 0%, #2E7D32 100%);
            color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .btn-primary {
            background: linear-gradient(90deg, #4CAF50 0%, #2E7D32 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            border: none;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3);
        }

        #map {
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .topic-tag {
            background: linear-gradient(90deg, #81C784 0%, #4CAF50 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
        }

        .clustering-plot {
            width: 100%;
            max-width: 800px;
            margin: 20px auto;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .csv-table {
            width: 100%;
            overflow-x: auto;
            margin: 20px 0;
        }

        .csv-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .csv-table th, .csv-table td {
            padding: 8px;
            border: 1px solid #ddd;
        }

        .csv-table th {
            background-color: #4CAF50;
            color: white;
        }

        /* Add new styles for farmer-friendly topics */
        .topic-card {
            border: 2px solid #4CAF50;
            border-radius: 1rem;
            transition: all 0.3s ease;
        }

        .topic-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.2);
        }

        .topic-icon {
            font-size: 2rem;
            color: #4CAF50;
        }

        .relevance-bar {
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .relevance-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #81C784);
            transition: width 0.3s ease;
        }

        .key-term-tag {
            background: #E8F5E9;
            color: #2E7D32;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            display: inline-block;
            margin: 0.25rem;
        }

        .language-selector {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            background: white;
            padding: 0.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .language-btn {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem;
            margin: 0.25rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .language-btn:hover {
            background-color: #f7fafc;
        }

        .language-btn.active {
            background-color: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        .flag-icon {
            margin-right: 0.5rem;
        }
    </style>
</head>

<body class="min-h-screen py-8">
    <div class="container mx-auto px-4">
        <div class="gradient-header mb-8">
            <h1 class="text-4xl font-bold text-center">ระบบวิเคราะห์โรคข้าว</h1>
            <p class="text-center mt-2 text-gray-100">เครื่องมือวิเคราะห์งานวิจัยโรคข้าวขั้นสูง</p>
        </div>

        <!-- Export and Search Controls -->
        <div class="card p-6 mb-8">
            <div class="flex flex-wrap justify-between items-center gap-4">
                <div class="flex gap-4">
                    <button onclick="exportData('csv')" class="btn-primary">ส่งออก CSV</button>
                    <button onclick="exportData('json')" class="btn-primary">ส่งออก JSON</button>
                </div>
                <div class="flex gap-2 flex-grow md:flex-grow-0">
                    <input type="text" id="searchKeyword" class="ant-input rounded-lg flex-grow" placeholder="ค้นหาคำสำคัญ...">
                    <select id="searchField" class="ant-input rounded-lg">
                        <option value="All">ทั้งหมด</option>
                        <option value="Title">ชื่อเรื่อง</option>
                        <option value="Abstract">บทคัดย่อ</option>
                    </select>
                    <button onclick="searchArticles()" class="btn-primary">ค้นหา</button>
                </div>
            </div>
        </div>

        <!-- Statistics Section -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            <div class="card p-6">
                <h2 class="text-2xl font-semibold mb-4 text-green-800">การกระจายของโรค</h2>
                <canvas id="diseaseChart"></canvas>
            </div>
            <div class="card p-6">
                <h2 class="text-2xl font-semibold mb-4 text-green-800">แนวโน้มรายปี</h2>
                <canvas id="yearlyChart"></canvas>
            </div>
            <div class="card p-6">
                <h2 class="text-2xl font-semibold mb-4 text-green-800">คำสำคัญยอดนิยม</h2>
                <div id="keywordCloud" class="flex flex-wrap gap-2"></div>
            </div>
        </div>

        <!-- News Section -->
        <div class="card p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-green-800">ข่าวสารโรคข้าวล่าสุด</h2>
            <div id="newsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- News articles will be loaded here -->
            </div>
        </div>

        <!-- Clustering Plot Image -->
        <div class="card p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-green-800">การวิเคราะห์กลุ่ม</h2>
            <img src="rice_disease_analysis/clustering_plots.png" alt="แผนภาพการจัดกลุ่ม" class="clustering-plot">
        </div>

        <!-- CSV Data -->
        <div class="card p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-green-800">ข้อมูลงานวิจัย</h2>
            <div class="csv-table" id="csvData">
                <!-- CSV data will be loaded here -->
            </div>
        </div>

        <!-- Status Card -->
        <div class="card p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-green-800">สถานะระบบ</h2>
            <div id="status" class="text-gray-700"></div>
        </div>

        <!-- Query Form -->
        <div class="card p-8 mb-8">
            <h2 class="text-2xl font-semibold mb-6 text-green-800">ค้นหางานวิจัย</h2>
            <form id="queryForm" class="space-y-6">
                <div>
                    <label class="block text-lg font-medium text-gray-700 mb-2">คำค้นหา</label>
                    <input type="text" id="query" class="ant-input text-lg p-3 rounded-lg w-full"
                        placeholder="ใส่คำค้นหา (เช่น โรคไหม้ข้าว)" required>
                </div>
                <div>
                    <label class="block text-lg font-medium text-gray-700 mb-2">จำนวนผลลัพธ์สูงสุด</label>
                    <input type="number" id="maxResults" class="ant-input text-lg p-3 rounded-lg w-full" value="1000"
                        min="1" max="5000">
                </div>
                <button type="submit" class="btn-primary w-full text-lg font-semibold">เริ่มวิเคราะห์</button>
            </form>
        </div>

        <!-- Visualization Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div class="card p-6">
                <h2 class="text-2xl font-semibold mb-4 text-green-800">การกระจายของหัวข้อ</h2>
                <canvas id="topicChart"></canvas>
            </div>
            <div class="card p-6">
                <h2 class="text-2xl font-semibold mb-4 text-green-800">แผนที่งานวิจัยทั่วโลก</h2>
                <div id="map" style="height: 400px;"></div>
            </div>
        </div>

        <!-- Analysis Results -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="card p-6">
                <h2 class="text-2xl font-semibold mb-6 text-green-800">กลุ่มงานวิจัย</h2>
                <div id="clusters" class="space-y-4"></div>
            </div>
            <div class="card p-6">
                <h2 class="text-2xl font-semibold mb-6 text-green-800">การวิเคราะห์หัวข้อสำหรับเกษตรกร</h2>
                <div id="farmerTopics" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Topics will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Articles Section -->
        <div class="card p-8 mt-8">
            <h2 class="text-2xl font-semibold mb-6 text-green-800">บทความวิจัย</h2>
            <div id="articlesContainer" class="space-y-6">
                <!-- Articles will be loaded here -->
            </div>
            <!-- Pagination Controls -->
            <div class="flex justify-between items-center mt-6">
                <div class="flex items-center gap-2">
                    <span class="text-gray-600">จำนวนต่อหน้า:</span>
                    <select id="pageSize" class="ant-input rounded-lg" onchange="changePageSize()">
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
                <div class="flex items-center gap-4">
                    <button id="prevPage" onclick="previousPage()" class="btn-primary" disabled>ก่อนหน้า</button>
                    <span id="pageInfo" class="text-gray-600">หน้า 1 จาก 1</span>
                    <button id="nextPage" onclick="nextPage()" class="btn-primary" disabled>ถัดไป</button>
                </div>
            </div>
        </div>
    </div>

    <div class="language-selector">
        <button onclick="changeLanguage('th')" class="language-btn active" id="lang-th">
            <span class="flag-icon flag-icon-th"></span> ไทย
        </button>
        <button onclick="changeLanguage('en')" class="language-btn" id="lang-en">
            <span class="flag-icon flag-icon-gb"></span> English
        </button>
        <button onclick="changeLanguage('zh')" class="language-btn" id="lang-zh">
            <span class="flag-icon flag-icon-cn"></span> 中文
        </button>
    </div>

    <script>
        // Update map center to Thailand
        function initMap() {
            map = L.map('map').setView([13.7563, 100.5018], 3);  // Zoomed out for global view
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            // Add legend
            const legend = L.control({ position: 'bottomright' });
            legend.onAdd = function (map) {
                const div = L.DomUtil.create('div', 'info legend');
                div.style.backgroundColor = 'white';
                div.style.padding = '10px';
                div.style.borderRadius = '5px';
                div.innerHTML = `
                    <h4 class="font-semibold mb-2">สัญลักษณ์แผนที่</h4>
                    <div class="flex items-center gap-2 mb-1">
                        <span class="inline-block w-3 h-3 rounded-full bg-red-500"></span>
                        <span>โรคระบาดรุนแรง</span>
                    </div>
                    <div class="flex items-center gap-2 mb-1">
                        <span class="inline-block w-3 h-3 rounded-full bg-yellow-500"></span>
                        <span>โรคระบาดปานกลาง</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="inline-block w-3 h-3 rounded-full bg-green-500"></span>
                        <span>โรคระบาดน้อย</span>
                    </div>
                `;
                return div;
            };
            legend.addTo(map);

            // Function to update map markers based on research data
            async function updateMapMarkers() {
                try {
                    const response = await fetch(`${API_URL}/research-locations`);
                    const data = await response.json();
                    
                    // Clear existing markers
                    map.eachLayer((layer) => {
                        if (layer instanceof L.Marker) {
                            map.removeLayer(layer);
                        }
                    });

                    // Add new markers
                    data.forEach(location => {
                        const markerColor = getMarkerColor(location.severity);
                        const customIcon = L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div style="background-color: ${markerColor}; width: 15px; height: 15px; border-radius: 50%; border: 2px solid white;"></div>`,
                            iconSize: [15, 15],
                            iconAnchor: [7, 7]
                        });

                        const marker = L.marker([location.lat, location.lng], { icon: customIcon })
                            .addTo(map)
                            .bindPopup(createPopupContent(location));

                        // Add click event for detailed information
                        marker.on('click', () => {
                            showDetailedInfo(location);
                        });
                    });
                } catch (error) {
                    console.error('Error updating map markers:', error);
                }
            }

            // Function to determine marker color based on severity
            function getMarkerColor(severity) {
                if (severity >= 7) return '#EF4444'; // red
                if (severity >= 4) return '#F59E0B'; // yellow
                return '#10B981'; // green
            }

            // Function to create popup content
            function createPopupContent(location) {
                return `
                    <div class="p-2">
                        <h3 class="font-semibold text-lg mb-2">${location.name}</h3>
                        <div class="mb-2">
                            <strong>โรคที่พบ:</strong> ${location.diseases.join(', ')}
                        </div>
                        <div class="mb-2">
                            <strong>ความรุนแรง:</strong> 
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div class="bg-green-600 h-2.5 rounded-full" style="width: ${location.severity * 10}%"></div>
                            </div>
                        </div>
                        <div class="mb-2">
                            <strong>จำนวนงานวิจัย:</strong> ${location.researchCount}
                        </div>
                        <button onclick="showDetailedInfo(${JSON.stringify(location).replace(/"/g, '&quot;')})" 
                                class="bg-green-600 text-white px-3 py-1 rounded-full text-sm hover:bg-green-700 transition-colors">
                            ดูรายละเอียด
                        </button>
                    </div>
                `;
            }

            // Function to show detailed information in a modal
            function showDetailedInfo(location) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                        <div class="flex justify-between items-start mb-4">
                            <h2 class="text-2xl font-semibold text-green-800">${location.name}</h2>
                            <button onclick="this.closest('.fixed').remove()" 
                                    class="text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <h3 class="font-semibold mb-2">โรคที่พบในพื้นที่</h3>
                                <div class="flex flex-wrap gap-2">
                                    ${location.diseases.map(disease => `
                                        <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm">
                                            ${disease}
                                        </span>
                                    `).join('')}
                                </div>
                            </div>
                            <div>
                                <h3 class="font-semibold mb-2">สถิติการวิจัย</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <p class="text-sm text-gray-600">จำนวนงานวิจัยทั้งหมด</p>
                                        <p class="text-2xl font-semibold text-green-600">${location.researchCount}</p>
                                    </div>
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <p class="text-sm text-gray-600">ระดับความรุนแรงของโรค</p>
                                        <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                                            <div class="bg-green-600 h-2.5 rounded-full" 
                                                 style="width: ${location.severity * 10}%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h3 class="font-semibold mb-2">แนวโน้มการระบาด</h3>
                                <canvas id="trendChart-${location.id}" class="w-full h-48"></canvas>
                            </div>
                            <div>
                                <h3 class="font-semibold mb-2">คำแนะนำสำหรับเกษตรกร</h3>
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <ul class="list-disc list-inside space-y-2">
                                        ${location.recommendations.map(rec => `
                                            <li class="text-green-800">${rec}</li>
                                        `).join('')}
                                    </ul>
                                </div>
                            </div>
                            <div>
                                <h3 class="font-semibold mb-2">งานวิจัยที่เกี่ยวข้อง</h3>
                                <div class="space-y-3">
                                    ${location.relatedResearch.map(research => `
                                        <div class="border-l-4 border-green-500 pl-4">
                                            <h4 class="font-medium">${research.title}</h4>
                                            <p class="text-sm text-gray-600">${research.authors.join(', ')}</p>
                                            <p class="text-sm text-gray-500">${research.year}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                // Initialize trend chart
                const ctx = document.getElementById(`trendChart-${location.id}`).getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: location.trends.map(t => t.year),
                        datasets: [{
                            label: 'จำนวนการระบาด',
                            data: location.trends.map(t => t.cases),
                            borderColor: '#059669',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            // Initial update of markers
            updateMapMarkers();

            // Update markers periodically
            setInterval(updateMapMarkers, 300000); // Update every 5 minutes
        }

        // [Previous JavaScript code remains the same]
        const API_URL = 'http://localhost:8000';
        let map;
        let topicChart;

        // Load CSV data
        async function loadCSVData() {
            try {
                const response = await fetch(`${API_URL}/csv-data`); // Changed to use API endpoint
                const data = await response.json();
                
                let tableHTML = '<table><thead><tr>';
                data.headers.forEach(header => {
                    tableHTML += `<th>${header}</th>`;
                });
                tableHTML += '</tr></thead><tbody>';

                data.rows.forEach(row => {
                    tableHTML += '<tr>';
                    row.forEach(cell => {
                        tableHTML += `<td>${cell}</td>`;
                    });
                    tableHTML += '</tr>';
                });
                
                tableHTML += '</tbody></table>';
                document.getElementById('csvData').innerHTML = tableHTML;
            } catch (error) {
                console.error('Error loading CSV:', error);
                document.getElementById('csvData').innerHTML = '<p class="text-red-500">Error loading data</p>';
            }
        }

        // Initialize chart
        function initChart() {
            const ctx = document.getElementById('topicChart').getContext('2d');
            topicChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#FF6384',
                            '#36A2EB',
                            '#FFCE56',
                            '#4BC0C0',
                            '#9966FF'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                        }
                    }
                }
            });
        }

        // Check API Status
        async function checkStatus() {
            try {
                const response = await fetch(`${API_URL}/status`);
                const status = await response.text();
                document.getElementById('status').textContent = status;
            } catch (error) {
                document.getElementById('status').textContent = 'API is not responding';
            }
        }

        // Handle form submission
        document.getElementById('queryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const query = document.getElementById('query').value;
            const maxResults = document.getElementById('maxResults').value;

            try {
                const button = e.target.querySelector('button');
                button.disabled = true;
                button.textContent = 'Analyzing...';

                const response = await fetch(`${API_URL}/analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query,
                        max_results: parseInt(maxResults)
                    })
                });
                const data = await response.json();
                antd.message.success(data.message);

                const pollInterval = setInterval(async () => {
                    try {
                        await loadClusters();
                        await loadFarmerTopics();
                        clearInterval(pollInterval);
                        button.disabled = false;
                        button.textContent = 'Analyze';
                    } catch (error) {
                        // Continue polling
                    }
                }, 5000);
            } catch (error) {
                antd.message.error('Error starting analysis');
            }
        });

        // Load clusters with visualization update
        async function loadClusters() {
            try {
                const response = await fetch(`${API_URL}/clusters`);
                const clusters = await response.json();

                // Update chart data
                topicChart.data.labels = clusters.map(c => `Cluster ${c.cluster_number}`);
                topicChart.data.datasets[0].data = clusters.map(c => c.article_count);
                topicChart.update();

                const clustersDiv = document.getElementById('clusters');
                clustersDiv.innerHTML = clusters.map(cluster => `
                    <div class="border rounded p-4 hover:shadow-lg cursor-pointer transition-shadow" 
                         onclick="loadArticles(${cluster.cluster_number})">
                        <h3 class="font-semibold">Cluster ${cluster.cluster_number}</h3>
                        <p class="text-sm text-gray-600">Articles: ${cluster.article_count}</p>
                        <div class="mt-2">
                            <p class="text-sm font-medium">Top Terms:</p>
                            <div class="flex flex-wrap gap-1 mt-1">
                                ${cluster.top_terms.map(term =>
                    `<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">${term}</span>`
                ).join('')}
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                antd.message.error('Error loading clusters');
            }
        }

        // Load articles with map markers
        async function loadArticles(clusterId) {
            try {
                const response = await fetch(`${API_URL}/articles/${clusterId}`);
                const articles = await response.json();

                // Clear existing markers
                map.eachLayer((layer) => {
                    if (layer instanceof L.Marker) {
                        map.removeLayer(layer);
                    }
                });

                const articlesDiv = document.getElementById('articles');
                articlesDiv.innerHTML = articles.map(article => `
                    <div class="border rounded-lg p-6 hover:shadow-lg transition-shadow">
                        <h3 class="font-semibold text-lg">${article.Title}</h3>
                        <p class="text-sm text-gray-600">PMID: ${article.PMID}</p>
                        <p class="mt-4 text-gray-700">${article.Abstract}</p>
                        <div class="mt-4 space-y-2">
                            <h4 class="font-medium">Entities:</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                ${Object.entries(article.Entities).map(([key, values]) => `
                                    <div class="bg-gray-50 p-3 rounded">
                                        <p class="font-medium text-sm">${key}:</p>
                                        <p class="text-sm text-gray-600">${values.join(', ')}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ${article.Dominant_Topic !== null ? `
                            <div class="mt-4">
                                <p class="text-sm"><span class="font-medium">Dominant Topic:</span> ${article.Dominant_Topic}</p>
                            </div>
                        ` : ''}
                    </div>
                `).join('');
            } catch (error) {
                antd.message.error('Error loading articles');
            }
        }

        // Load LDA topics
        async function loadFarmerTopics() {
            try {
                const response = await fetch(`${API_URL}/farmer-topics`);
                const topics = await response.json();

                const topicsDiv = document.getElementById('farmerTopics');
                topicsDiv.innerHTML = topics.map(topic => `
                    <div class="topic-card p-6">
                        <div class="flex items-center gap-4 mb-4">
                            <div class="topic-icon">
                                ${getTopicIcon(topic.topic_id)}
                            </div>
                            <div>
                                <h3 class="font-semibold text-lg text-green-800">${topic.main_focus}</h3>
                                <div class="relevance-bar mt-2">
                                    <div class="relevance-fill" style="width: ${topic.relevance_score}%"></div>
                                </div>
                                <p class="text-sm text-gray-600 mt-1">ความสำคัญ: ${topic.relevance_score}%</p>
                            </div>
                        </div>
                        <p class="text-gray-700 mb-4">${topic.simple_explanation}</p>
                        <div class="flex flex-wrap gap-2">
                            ${topic.key_terms.map(term => `
                                <span class="key-term-tag">${term}</span>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                antd.message.error('Error loading farmer-friendly topics');
            }
        }

        // Helper function to get topic icons
        function getTopicIcon(topicId) {
            const icons = {
                0: '🛡️', // Prevention
                1: '🦠', // Disease and pathogens
                2: '🌾', // Rice management
                3: '🔍', // Disease inspection
                4: '🔬'  // Research and development
            };
            return icons[topicId] || '📋';
        }

        // Add new JavaScript functions for the features
        async function exportData(format) {
            try {
                const response = await fetch(`${API_URL}/export/${format}`);
                if (!response.ok) throw new Error('Export failed');
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `rice_disease_analysis.${format}`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                antd.message.success(`Successfully exported data as ${format.toUpperCase()}`);
            } catch (error) {
                antd.message.error('Error exporting data');
            }
        }

        let diseaseChart, yearlyChart;

        function initStatisticsCharts() {
            // Initialize Disease Distribution Chart
            const diseaseCtx = document.getElementById('diseaseChart').getContext('2d');
            diseaseChart = new Chart(diseaseCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Disease Occurrences',
                        data: [],
                        backgroundColor: '#4CAF50'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Initialize Yearly Trends Chart
            const yearlyCtx = document.getElementById('yearlyChart').getContext('2d');
            yearlyChart = new Chart(yearlyCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Publications per Year',
                        data: [],
                        borderColor: '#2196F3',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        async function loadStatistics() {
            try {
                const response = await fetch(`${API_URL}/statistics`);
                const data = await response.json();

                // Update Disease Chart
                diseaseChart.data.labels = Object.keys(data.disease_counts);
                diseaseChart.data.datasets[0].data = Object.values(data.disease_counts);
                diseaseChart.update();

                // Update Yearly Chart
                const sortedYears = Object.entries(data.yearly_trends)
                    .sort(([a], [b]) => a.localeCompare(b));
                yearlyChart.data.labels = sortedYears.map(([year]) => year);
                yearlyChart.data.datasets[0].data = sortedYears.map(([, count]) => count);
                yearlyChart.update();

                // Update Keyword Cloud
                const keywordCloud = document.getElementById('keywordCloud');
                keywordCloud.innerHTML = data.top_keywords
                    .map(({word, count}) => `
                        <span class="px-3 py-1 rounded-full text-sm font-medium"
                              style="background-color: rgba(76, 175, 80, ${Math.min(count / Math.max(...data.top_keywords.map(k => k.count)), 0.9)})">
                            ${word}
                        </span>
                    `)
                    .join('');
            } catch (error) {
                antd.message.error('Error loading statistics');
            }
        }

        // Initialize everything
        initMap();
        initChart();
        initStatisticsCharts();
        checkStatus();
        loadClusters();
        loadFarmerTopics();
        loadCSVData();
        loadStatistics();

        // Add these variables at the top of your script
        let currentPage = 1;
        let totalPages = 1;
        let pageSize = 10;

        // Function to load articles with pagination
        async function loadArticles() {
            try {
                const response = await fetch(`${API_URL}/articles?page=${currentPage}&page_size=${pageSize}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                // Update pagination info
                totalPages = data.total_pages;
                currentPage = data.page;
                
                // Update UI
                document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
                document.getElementById('prevPage').disabled = currentPage <= 1;
                document.getElementById('nextPage').disabled = currentPage >= totalPages;
                
                // Display articles
                const container = document.getElementById('articlesContainer');
                container.innerHTML = '';
                
                data.items.forEach(article => {
                    const articleElement = document.createElement('div');
                    articleElement.className = 'border-b border-gray-200 pb-6 mb-6 last:border-b-0';
                    articleElement.innerHTML = `
                        <h3 class="text-xl font-semibold text-green-800 mb-2">${article.Title}</h3>
                        <p class="text-gray-600 mb-2">PMID: ${article.PMID} | Cluster: ${article.Cluster}</p>
                        <p class="text-gray-700 mb-4">${article.Abstract}</p>
                        <div class="flex flex-wrap gap-2">
                            ${Object.entries(article.Entities).map(([category, items]) => `
                                <div class="flex flex-col">
                                    <span class="text-sm font-semibold text-green-700">${category}:</span>
                                    <div class="flex flex-wrap gap-1">
                                        ${items.map(item => `
                                            <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">${item}</span>
                                        `).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    container.appendChild(articleElement);
                });
            } catch (error) {
                console.error('Error loading articles:', error);
                document.getElementById('articlesContainer').innerHTML = 
                    '<p class="text-center text-red-500 my-4">Error loading articles. Please try again.</p>';
            }
        }

        // Navigation functions
        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                loadArticles();
            }
        }

        function nextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                loadArticles();
            }
        }

        function changePageSize() {
            pageSize = parseInt(document.getElementById('pageSize').value);
            currentPage = 1;  // Reset to first page
            loadArticles();
        }

        // Load initial articles when page loads
        document.addEventListener('DOMContentLoaded', () => {
            loadArticles();
        });

        // Update the search function to work with pagination
        async function searchArticles() {
            const keyword = document.getElementById('searchKeyword').value;
            const field = document.getElementById('searchField').value;
            
            if (!keyword) {
                antd.message.warning('Please enter a search keyword');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/search`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ keyword, field })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const articles = await response.json();
                
                // Reset pagination when searching
                currentPage = 1;
                
                // Display results in the articles container
                const container = document.getElementById('articlesContainer');
                
                if (articles.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-500 my-4">No articles found matching your search criteria.</p>';
                    // Update pagination UI for no results
                    document.getElementById('pageInfo').textContent = 'Page 0 of 0';
                    document.getElementById('prevPage').disabled = true;
                    document.getElementById('nextPage').disabled = true;
                    return;
                }
                
                // Display the search results
                container.innerHTML = articles.map(article => `
                    <div class="border-b border-gray-200 pb-6 mb-6 last:border-b-0">
                        <h3 class="text-xl font-semibold text-green-800 mb-2">${article.Title}</h3>
                        <p class="text-gray-600 mb-2">PMID: ${article.PMID} | Cluster: ${article.Cluster}</p>
                        <p class="text-gray-700 mb-4">${article.Abstract}</p>
                        <div class="flex flex-wrap gap-2">
                            ${Object.entries(article.Entities).map(([category, items]) => `
                                <div class="flex flex-col">
                                    <span class="text-sm font-semibold text-green-700">${category}:</span>
                                    <div class="flex flex-wrap gap-1">
                                        ${items.map(item => `
                                            <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">${item}</span>
                                        `).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
                
                // Show success message
                antd.message.success(`Found ${articles.length} matching articles`);
                
            } catch (error) {
                console.error('Error searching articles:', error);
                antd.message.error('Error searching articles. Please try again.');
                document.getElementById('articlesContainer').innerHTML = 
                    '<p class="text-center text-red-500 my-4">Error searching articles. Please try again.</p>';
            }
        }

        // Function to load news articles
        async function loadNews() {
            try {
                const response = await fetch(`${API_URL}/news`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const articles = await response.json();
                
                const container = document.getElementById('newsContainer');
                container.innerHTML = articles.map(article => `
                    <div class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow">
                        ${article.urlToImage ? `
                            <img src="${article.urlToImage}" 
                                 alt="${article.title}"
                                 class="w-full h-48 object-cover"
                                 onerror="this.onerror=null; this.src='https://via.placeholder.com/400x200?text=No+Image';">
                        ` : `
                            <div class="w-full h-48 bg-gray-200 flex items-center justify-center">
                                <span class="text-gray-500">No Image Available</span>
                            </div>
                        `}
                        <div class="p-4">
                            <h3 class="text-lg font-semibold text-green-800 mb-2 line-clamp-2">
                                ${article.title}
                            </h3>
                            <p class="text-gray-600 text-sm mb-3 line-clamp-3">
                                ${article.description || 'No description available'}
                            </p>
                            <div class="flex justify-between items-center">
                                <span class="text-xs text-gray-500">
                                    ${new Date(article.publishedAt).toLocaleDateString()}
                                </span>
                                <a href="${article.url}" 
                                   target="_blank" 
                                   class="text-green-600 hover:text-green-800 text-sm font-medium">
                                    Read More →
                                </a>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading news:', error);
                document.getElementById('newsContainer').innerHTML = 
                    '<p class="text-center text-red-500 col-span-full">Error loading news articles. Please try again later.</p>';
            }
        }

        // Add loadNews to the initialization
        document.addEventListener('DOMContentLoaded', () => {
            loadArticles();
            loadNews();  // Add this line
        });

        let currentLanguage = 'th';
        const translationCache = {};

        async function translateText(text, targetLang) {
            if (!text || !text.trim()) return text;
            
            const cacheKey = `${text}_${targetLang}`;
            if (translationCache[cacheKey]) {
                return translationCache[cacheKey];
            }

            try {
                const response = await fetch(`${API_URL}/translate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: text,
                        target_language: targetLang
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Translation error:', errorData);
                    return text;
                }

                const data = await response.json();
                translationCache[cacheKey] = data.translated_text;
                return data.translated_text;
            } catch (error) {
                console.error('Translation error:', error);
                return text;
            }
        }

        async function translateBulk(texts, targetLang) {
            if (!texts || texts.length === 0) return texts;

            // Filter out empty texts
            const validTexts = texts.filter(text => text && text.trim());
            if (validTexts.length === 0) return texts;

            try {
                // Split into smaller batches of 5
                const batchSize = 5;
                const results = [];
                
                for (let i = 0; i < validTexts.length; i += batchSize) {
                    const batch = validTexts.slice(i, i + batchSize);
                    try {
                        const response = await fetch(`${API_URL}/translate-bulk`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                texts: batch,
                                target_language: targetLang
                            })
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            console.error('Batch translation error:', errorData);
                            results.push(...batch); // Use original texts on error
                            continue;
                        }

                        const data = await response.json();
                        results.push(...data.translations.map(t => t.translated_text));
                    } catch (error) {
                        console.error('Batch translation error:', error);
                        results.push(...batch); // Use original texts on error
                    }
                    
                    // Add a small delay between batches
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                return results;
            } catch (error) {
                console.error('Bulk translation error:', error);
                return texts;
            }
        }

        async function changeLanguage(lang) {
            if (currentLanguage === lang) return;

            // Update button states
            document.querySelectorAll('.language-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`lang-${lang}`).classList.add('active');

            try {
                // Show loading message
                const loadingMessage = document.createElement('div');
                loadingMessage.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded shadow-lg z-50';
                loadingMessage.textContent = 'Translating content...';
                document.body.appendChild(loadingMessage);

                // Get all translatable elements
                const elements = document.querySelectorAll('h1, h2, h3, h4, h5, h6, p, span, button, a');
                const textsToTranslate = [];
                const elementsToUpdate = [];

                // Collect all texts that need translation
                elements.forEach(element => {
                    const text = element.textContent.trim();
                    if (text && !element.closest('script') && !element.closest('style')) {
                        textsToTranslate.push(text);
                        elementsToUpdate.push(element);
                    }
                });

                // Translate in smaller batches
                const batchSize = 5;
                for (let i = 0; i < textsToTranslate.length; i += batchSize) {
                    const batch = textsToTranslate.slice(i, i + batchSize);
                    try {
                        const translations = await translateBulk(batch, lang);
                        translations.forEach((translation, index) => {
                            const element = elementsToUpdate[i + index];
                            if (element) {
                                if (!element.getAttribute('data-original')) {
                                    element.setAttribute('data-original', element.textContent);
                                }
                                element.textContent = translation;
                            }
                        });
                    } catch (error) {
                        console.error('Translation error for batch:', error);
                    }
                    
                    // Update progress
                    const progress = Math.min(100, Math.round((i + batchSize) / textsToTranslate.length * 100));
                    loadingMessage.textContent = `Translating content... ${progress}%`;
                    
                    // Add a small delay between batches
                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                // Update current language
                currentLanguage = lang;
                document.documentElement.lang = lang;

                // Update dynamic content
                const updateFunctions = [
                    { fn: loadArticles, name: 'articles' },
                    { fn: loadClusters, name: 'clusters' },
                    { fn: loadFarmerTopics, name: 'farmer topics' },
                    { fn: loadStatistics, name: 'statistics' },
                    { fn: loadNews, name: 'news' }
                ];

                for (const { fn, name } of updateFunctions) {
                    if (typeof fn === 'function') {
                        try {
                            loadingMessage.textContent = `Updating ${name}...`;
                            await fn();
                        } catch (error) {
                            console.error(`Error updating ${name}:`, error);
                        }
                    }
                }

                // Remove loading message and show success message
                document.body.removeChild(loadingMessage);
                const successMessage = document.createElement('div');
                successMessage.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded shadow-lg z-50';
                successMessage.textContent = 'Language changed successfully';
                document.body.appendChild(successMessage);
                setTimeout(() => {
                    document.body.removeChild(successMessage);
                }, 3000);

            } catch (error) {
                console.error('Language change error:', error);
                const errorMessage = document.createElement('div');
                errorMessage.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded shadow-lg z-50';
                errorMessage.textContent = 'Error changing language';
                document.body.appendChild(errorMessage);
                setTimeout(() => {
                    document.body.removeChild(errorMessage);
                }, 3000);
            }
        }

        // Add language persistence
        document.addEventListener('DOMContentLoaded', () => {
            // Load saved language preference
            const savedLanguage = localStorage.getItem('preferredLanguage');
            if (savedLanguage && savedLanguage !== currentLanguage) {
                changeLanguage(savedLanguage);
            }
            
            // Initialize content
            loadArticles();
            loadNews();
        });

        // Update language buttons to save preference
        document.querySelectorAll('.language-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const lang = e.currentTarget.id.replace('lang-', '');
                localStorage.setItem('preferredLanguage', lang);
            });
        });

        // Modify existing functions to support translation
        const originalLoadArticles = loadArticles;
        loadArticles = async function() {
            await originalLoadArticles();
            if (currentLanguage !== 'th') {
                // Translate the loaded articles
                const articles = document.querySelectorAll('#articlesContainer .article');
                for (const article of articles) {
                    const title = article.querySelector('h3');
                    const abstract = article.querySelector('p');
                    
                    if (title && abstract) {
                        title.textContent = await translateText(title.textContent, currentLanguage);
                        abstract.textContent = await translateText(abstract.textContent, currentLanguage);
                    }
                }
            }
        };

        // Similarly modify other loading functions to support translation
        // Add translation support to other dynamic content loading functions as needed
    </script>
</body>

</html>