<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบวิเคราะห์โรคข้าว</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- Add Thai font -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/flag-icon-css@3.5.0/css/flag-icon.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <!-- Add Marked.js library for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
    <script>
        // Ensure marked is available globally with better error checking
        window.onload = function() {
            if (typeof marked === 'undefined' || typeof marked.parse !== 'function') {
                console.warn('Marked library not loaded properly. Using fallback.');
                window.marked = {
                    parse: function(text) {
                        return text ? text.replace(/\n/g, '<br>') : '';
                    }
                };
            } else {
                // Configure marked for security and performance
                marked.setOptions({
                    sanitize: true,
                    gfm: true,
                    breaks: true
                });
            }
        };
    </script>
    <!-- External CSS file -->
    <link rel="stylesheet" href="styles/main.css">
</head>

<body class="min-h-screen py-8">
    <div class="container mx-auto px-4">
        <div class="gradient-header mb-8">
            <h1 class="text-4xl font-bold text-center">ระบบวิเคราะห์โรคข้าว</h1>
            <p class="text-center mt-2 text-gray-100">เครื่องมือวิเคราะห์งานวิจัยโรคข้าวขั้นสูง</p>
        </div>

        <!-- Export and Search Controls -->
        <div class="card p-6 mb-8">
            <div class="flex flex-wrap justify-between items-center gap-4">
                <div class="flex gap-4">
                    <button onclick="exportData('csv')" class="btn-primary flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        ส่งออก CSV
                    </button>
                    <button onclick="exportData('json')" class="btn-primary flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        ส่งออก JSON
                    </button>
                </div>
                <div class="flex gap-2 flex-grow md:flex-grow-0">
                    <div class="search-container">
                        <svg class="search-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <input type="text" id="searchKeyword" class="search-input" placeholder="ค้นหาคำสำคัญ...">
                    </div>
                    <select id="searchField" class="border border-gray-300 rounded-lg p-2">
                        <option value="All">ทั้งหมด</option>
                        <option value="Title">ชื่อเรื่อง</option>
                        <option value="Abstract">บทคัดย่อ</option>
                    </select>
                    <button onclick="searchArticles()" class="btn-primary flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        ค้นหา
                    </button>
                </div>
            </div>
        </div>

        <!-- Statistics Section -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8 staggered-fade-in">
            <div class="card p-6">
                <h2 class="section-title text-2xl">การกระจายของโรค</h2>
                <canvas id="diseaseChart"></canvas>
            </div>
            <div class="card p-6">
                <h2 class="section-title text-2xl">แนวโน้มรายปี</h2>
                <canvas id="yearlyChart"></canvas>
            </div>
            <div class="card p-6">
                <h2 class="section-title text-2xl">คำสำคัญยอดนิยม</h2>
                <div id="keywordCloud" class="flex flex-wrap gap-2"></div>
            </div>
        </div>

        <!-- News Section -->
        <div class="card p-6 mb-8 fade-in">
            <h2 class="section-title text-2xl">ข่าวสารโรคข้าวล่าสุด</h2>
            <div id="newsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 staggered-fade-in">
                <!-- News articles will be loaded here with improved styling -->
            </div>
        </div>

        <!-- Clustering Plot Image -->
        <div class="card p-6 mb-8 fade-in">
            <h2 class="section-title text-2xl">การวิเคราะห์กลุ่ม</h2>
            <img src="rice_disease_analysis/clustering_plots.png" alt="แผนภาพการจัดกลุ่ม" class="clustering-plot">
        </div>

        <!-- CSV Data -->
        <div class="card p-6 mb-8 fade-in">
            <h2 class="section-title text-2xl">ข้อมูลงานวิจัย</h2>
            <div class="csv-table" id="csvData">
                <!-- CSV data will be loaded here with improved styling -->
            </div>
        </div>

        <!-- Status Card -->
        <div class="card p-6 mb-8 fade-in">
            <h2 class="section-title text-2xl">สถานะระบบ</h2>
            <div id="status" class="text-gray-700 p-4 bg-gray-50 rounded-lg"></div>
        </div>

        <!-- Query Form -->
        <div class="card p-8 mb-8 fade-in">
            <h2 class="section-title text-2xl">ค้นหางานวิจัย</h2>
            <form id="queryForm" class="space-y-6">
                <div>
                    <label class="block text-lg font-medium text-gray-700 mb-2">คำค้นหา</label>
                    <input type="text" id="query" class="border border-gray-300 text-lg p-3 rounded-lg w-full"
                        placeholder="ใส่คำค้นหา (เช่น โรคไหม้ข้าว)" required>
                </div>
                <div>
                    <label class="block text-lg font-medium text-gray-700 mb-2">จำนวนผลลัพธ์สูงสุด</label>
                    <input type="number" id="maxResults" class="border border-gray-300 text-lg p-3 rounded-lg w-full" value="1000"
                        min="1" max="5000">
                </div>
                <button type="submit" class="btn-primary w-full text-lg font-semibold flex items-center justify-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2z"></path>
                    </svg>
                    เริ่มวิเคราะห์
                </button>
            </form>
        </div>

        <!-- Visualization Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div class="card p-6">
                <h2 class="text-2xl font-semibold mb-4 text-green-800">การกระจายของหัวข้อ</h2>
                <canvas id="topicChart"></canvas>
            </div>
            <div class="card p-6">
                <h2 class="text-2xl font-semibold mb-4 text-green-800">แผนที่งานวิจัยทั่วโลก</h2>
                <div id="map" style="height: 400px;"></div>
            </div>
        </div>

        <!-- Analysis Results -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="card p-6">
                <h2 class="text-2xl font-semibold mb-6 text-green-800">กลุ่มงานวิจัย</h2>
                <div id="clusters" class="space-y-4"></div>
            </div>
            <div class="card p-6">
                <h2 class="text-2xl font-semibold mb-6 text-green-800">การวิเคราะห์หัวข้อสำหรับเกษตรกร</h2>
                <div id="farmerTopics" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Topics will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Articles Section -->
        <div class="card p-8 mt-8">
            <h2 class="text-2xl font-semibold mb-6 text-green-800">บทความวิจัย</h2>
            <div id="articlesContainer" class="space-y-6">
                <!-- Articles will be loaded here -->
            </div>
            <!-- Pagination Controls -->
            <div class="flex justify-between items-center mt-6">
                <div class="flex items-center gap-2">
                    <span class="text-gray-600">จำนวนต่อหน้า:</span>
                    <select id="pageSize" class="border border-gray-300 rounded-lg p-2" onchange="changePageSize()">
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
                <div class="flex items-center gap-4">
                    <button id="prevPage" onclick="previousPage()" class="btn-primary" disabled>ก่อนหน้า</button>
                    <span id="pageInfo" class="text-gray-600">หน้า 1 จาก 1</span>
                    <button id="nextPage" onclick="nextPage()" class="btn-primary" disabled>ถัดไป</button>
                </div>
            </div>
        </div>

        <!-- Disease Solutions Section -->
        <div class="card p-8 mt-8">
            <h2 class="text-2xl font-semibold mb-6 text-green-800">วิธีการรักษาโรคข้าว</h2>
            <div id="diseaseSolutions" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Disease solutions will be loaded here -->
            </div>
        </div>

        <!-- Add Rice Disease Analysis Section -->
        <div class="card p-8 mt-8 fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-green-800">การวิเคราะห์โรคข้าวขั้นสูง</h2>
                <button id="analyzeRiceDiseases" class="btn-primary flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2z"></path>
                    </svg>
                    วิเคราะห์โรคข้าว
                </button>
            </div>
            <div id="riceAnalysisResults" class="space-y-6">
                <div class="text-center text-gray-500">คลิกปุ่ม "วิเคราะห์โรคข้าว" เพื่อเริ่มการวิเคราะห์</div>
            </div>
        </div>

        <!-- Add after line 150 -->
        <div class="card p-6 mb-8 fade-in">
            <h2 class="text-2xl font-semibold mb-6 text-green-800">สรุปกลุ่มงานวิจัย</h2>
            <div id="clusterSummaries" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>
    </div>

    <div class="language-selector">
        <button onclick="changeLanguage('th')" class="language-btn active" id="lang-th">
            <span class="flag-icon flag-icon-th"></span> ไทย
        </button>
        <button onclick="changeLanguage('en')" class="language-btn" id="lang-en">
            <span class="flag-icon flag-icon-gb"></span> English
        </button>
        <button onclick="changeLanguage('zh')" class="language-btn" id="lang-zh">
            <span class="flag-icon flag-icon-cn"></span> 中文
        </button>
    </div>

    <script>
        // Add this at the beginning of your script
        let mapInitialized = false;
        let chartsInitialized = false;

        // Replace the current lazyInitMap function with this more robust version
        function lazyInitMap() {
            if (mapInitialized) return;
            
            const mapElement = document.getElementById('map');
            if (!mapElement) {
                console.error('Map container not found');
                return;
            }
            
            if (mapElement.offsetParent === null) {
                // Map is not visible yet, we'll try again later
                return;
            }
            
            try {
                // Initialize the map with error handling
                map = L.map('map', {
                    minZoom: 2,
                    maxBoundsViscosity: 1.0
                }).setView([13.7563, 100.5018], 3);
                
                // Set max bounds to prevent users from panning too far
                const southWest = L.latLng(-89.98155760646617, -180);
                const northEast = L.latLng(89.99346179538875, 180);
                const bounds = L.latLngBounds(southWest, northEast);
                map.setMaxBounds(bounds);
                
                // Add tile layer with error handling
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors',
                    noWrap: true
                }).addTo(map);
                
                // Add legend
                const legend = L.control({ position: 'bottomright' });
                legend.onAdd = function (map) {
                    const div = L.DomUtil.create('div', 'info legend');
                    div.style.backgroundColor = 'white';
                    div.style.padding = '10px';
                    div.style.borderRadius = '5px';
                    div.innerHTML = `
                        <h4 class="font-semibold mb-2">สัญลักษณ์แผนที่</h4>
                        <div class="flex items-center gap-2 mb-1">
                            <span class="inline-block w-3 h-3 rounded-full bg-red-500"></span>
                            <span>โรคระบาดรุนแรง</span>
                        </div>
                        <div class="flex items-center gap-2 mb-1">
                            <span class="inline-block w-3 h-3 rounded-full bg-yellow-500"></span>
                            <span>โรคระบาดปานกลาง</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="inline-block w-3 h-3 rounded-full bg-green-500"></span>
                            <span>โรคระบาดน้อย</span>
                        </div>
                    `;
                    return div;
                };
                legend.addTo(map);
                
                mapInitialized = true;
                console.log('Map initialized successfully');
                
                // Load markers after map is initialized
                updateMapMarkers();
            } catch (error) {
                console.error('Error initializing map:', error);
                const mapElement = document.getElementById('map');
                if (mapElement) {
                    mapElement.innerHTML = '<div class="bg-red-100 text-red-600 p-4 rounded">Error loading map. Please refresh the page.</div>';
                }
            }
        }

        // Use Intersection Observer to initialize map when visible
        function observeMapVisibility() {
            const mapElement = getElement('map');
            if (!mapElement) return;
            
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        lazyInitMap();
                        observer.disconnect();
                    }
                });
            }, { threshold: 0.1 });
            
            observer.observe(mapElement);
        }

        // Replace the existing chart initialization with this more robust version
        function lazyInitCharts() {
            if (chartsInitialized) return;
            
            const chartElements = [
                document.getElementById('topicChart'),
                document.getElementById('diseaseChart'),
                document.getElementById('yearlyChart')
            ];
            
            // Check if any chart elements exist and are visible
            const anyVisible = chartElements.some(el => el && el.offsetParent !== null);
            if (!anyVisible) return;
            
            try {
                // Destroy any existing charts
                if (topicChart instanceof Chart) {
                    topicChart.destroy();
                }
                if (diseaseChart instanceof Chart) {
                    diseaseChart.destroy();
                }
                if (yearlyChart instanceof Chart) {
                    yearlyChart.destroy();
                }
                
                // Initialize charts
                initChart();
                initStatisticsCharts();
                chartsInitialized = true;
                console.log('Charts initialized successfully');
            } catch (error) {
                console.error('Error initializing charts:', error);
                
                // Provide fallback for failed charts
                chartElements.forEach(element => {
                    if (element) {
                        element.innerHTML = '<div class="p-4 bg-red-50 rounded text-red-600">Error loading chart</div>';
                    }
                });
            }
        }

        // Add this to your DOMContentLoaded event
        document.addEventListener('DOMContentLoaded', () => {
            // ... existing code ...
            
            // Use lazy initialization
            observeMapVisibility();
            
            // Initialize charts only when needed
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        lazyInitCharts();
                        observer.disconnect();
                    }
                });
            }, { threshold: 0.1 });
            
            const chartContainer = document.querySelector('.grid.grid-cols-1.lg\\:grid-cols-2.gap-8.mb-8');
            if (chartContainer) {
                observer.observe(chartContainer);
            }
        });

        // Update map center to Thailand
        function initMap() {
            map = L.map('map').setView([13.7563, 100.5018], 3);  // Zoomed out for global view
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            // Add legend
            const legend = L.control({ position: 'bottomright' });
            legend.onAdd = function (map) {
                const div = L.DomUtil.create('div', 'info legend');
                div.style.backgroundColor = 'white';
                div.style.padding = '10px';
                div.style.borderRadius = '5px';
                div.innerHTML = `
                    <h4 class="font-semibold mb-2">สัญลักษณ์แผนที่</h4>
                    <div class="flex items-center gap-2 mb-1">
                        <span class="inline-block w-3 h-3 rounded-full bg-red-500"></span>
                        <span>โรคระบาดรุนแรง</span>
                    </div>
                    <div class="flex items-center gap-2 mb-1">
                        <span class="inline-block w-3 h-3 rounded-full bg-yellow-500"></span>
                        <span>โรคระบาดปานกลาง</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="inline-block w-3 h-3 rounded-full bg-green-500"></span>
                        <span>โรคระบาดน้อย</span>
                    </div>
                `;
                return div;
            };
            legend.addTo(map);

            // Function to update map markers based on research data
            async function updateMapMarkers() {
                try {
                    const response = await fetch(`${API_URL}/research-locations`);
                    const data = await response.json();
                    
                    // Clear existing markers
                    map.eachLayer((layer) => {
                        if (layer instanceof L.Marker) {
                            map.removeLayer(layer);
                        }
                    });

                    // Add new markers
                    data.forEach(location => {
                        const markerColor = getMarkerColor(location.severity);
                        const customIcon = L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div style="background-color: ${markerColor}; width: 15px; height: 15px; border-radius: 50%; border: 2px solid white;"></div>`,
                            iconSize: [15, 15],
                            iconAnchor: [7, 7]
                        });

                        const marker = L.marker([location.lat, location.lng], { icon: customIcon })
                            .addTo(map)
                            .bindPopup(createPopupContent(location));

                        // Add click event for detailed information
                        marker.on('click', () => {
                            showDetailedInfo(location);
                        });
                    });
                } catch (error) {
                    console.error('Error updating map markers:', error);
                }
            }

            // Function to determine marker color based on severity
            function getMarkerColor(severity) {
                if (severity >= 7) return '#EF4444'; // red
                if (severity >= 4) return '#F59E0B'; // yellow
                return '#10B981'; // green
            }

            // Function to create popup content
            function createPopupContent(location) {
                return `
                    <div class="p-2">
                        <h3 class="font-semibold text-lg mb-2">${location.name}</h3>
                        <div class="mb-2">
                            <strong>โรคที่พบ:</strong> ${location.diseases.join(', ')}
                        </div>
                        <div class="mb-2">
                            <strong>ความรุนแรง:</strong> 
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div class="bg-green-600 h-2.5 rounded-full" style="width: ${location.severity * 10}%"></div>
                            </div>
                        </div>
                        <div class="mb-2">
                            <strong>จำนวนงานวิจัย:</strong> ${location.researchCount}
                        </div>
                        <button onclick="showDetailedInfo(${JSON.stringify(location).replace(/"/g, '&quot;')})" 
                                class="bg-green-600 text-white px-3 py-1 rounded-full text-sm hover:bg-green-700 transition-colors">
                            ดูรายละเอียด
                        </button>
                    </div>
                `;
            }

            // Function to show detailed information in a modal
            function showDetailedInfo(location) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                        <div class="flex justify-between items-start mb-4">
                            <h2 class="text-2xl font-semibold text-green-800">${location.name}</h2>
                            <button onclick="this.closest('.fixed').remove()" 
                                    class="text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <h3 class="font-semibold mb-2">โรคที่พบในพื้นที่</h3>
                                <div class="flex flex-wrap gap-2">
                                    ${location.diseases.map(disease => `
                                        <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm">
                                            ${disease}
                                        </span>
                                    `).join('')}
                                </div>
                            </div>
                            <div>
                                <h3 class="font-semibold mb-2">สถิติการวิจัย</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <p class="text-sm text-gray-600">จำนวนงานวิจัยทั้งหมด</p>
                                        <p class="text-2xl font-semibold text-green-600">${location.researchCount}</p>
                                    </div>
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <p class="text-sm text-gray-600">ระดับความรุนแรงของโรค</p>
                                        <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                                            <div class="bg-green-600 h-2.5 rounded-full" 
                                                 style="width: ${location.severity * 10}%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h3 class="font-semibold mb-2">แนวโน้มการระบาด</h3>
                                <canvas id="trendChart-${location.id}" class="w-full h-48"></canvas>
                            </div>
                            <div>
                                <h3 class="font-semibold mb-2">คำแนะนำสำหรับเกษตรกร</h3>
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <ul class="list-disc list-inside space-y-2">
                                        ${location.recommendations.map(rec => `
                                            <li class="text-green-800">${rec}</li>
                                        `).join('')}
                                    </ul>
                                </div>
                            </div>
                            <div>
                                <h3 class="font-semibold mb-2">งานวิจัยที่เกี่ยวข้อง</h3>
                                <div class="space-y-3">
                                    ${location.relatedResearch.map(research => `
                                        <div class="border-l-4 border-green-500 pl-4">
                                            <h4 class="font-medium">${research.title}</h4>
                                            <p class="text-sm text-gray-600">${research.authors.join(', ')}</p>
                                            <p class="text-sm text-gray-500">${research.year}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                // Initialize trend chart
                const ctx = document.getElementById(`trendChart-${location.id}`).getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: location.trends.map(t => t.year),
                        datasets: [{
                            label: 'จำนวนการระบาด',
                            data: location.trends.map(t => t.cases),
                            borderColor: '#059669',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            // Initial update of markers
            updateMapMarkers();

            // Update markers periodically
            setInterval(updateMapMarkers, 300000); // Update every 5 minutes
        }

        // [Previous JavaScript code remains the same]
        const API_URL = 'http://localhost:8000';
        let map;
        let topicChart;

        // Load CSV data
        async function loadCSVData() {
            try {
                const response = await fetch(`${API_URL}/csv-data`); // Changed to use API endpoint
                const data = await response.json();
                
                let tableHTML = '<table><thead><tr>';
                data.headers.forEach(header => {
                    tableHTML += `<th>${header}</th>`;
                });
                tableHTML += '</tr></thead><tbody>';

                data.rows.forEach(row => {
                    tableHTML += '<tr>';
                    row.forEach(cell => {
                        tableHTML += `<td>${cell}</td>`;
                    });
                    tableHTML += '</tr>';
                });
                
                tableHTML += '</tbody></table>';
                document.getElementById('csvData').innerHTML = tableHTML;
            } catch (error) {
                console.error('Error loading CSV:', error);
                document.getElementById('csvData').innerHTML = '<p class="text-red-500">Error loading data</p>';
            }
        }

        // Initialize chart
        function initChart() {
            const ctx = document.getElementById('topicChart').getContext('2d');
            topicChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#FF6384',
                            '#36A2EB',
                            '#FFCE56',
                            '#4BC0C0',
                            '#9966FF'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                        }
                    }
                }
            });
        }

        // Check API Status
        async function checkStatus() {
            try {
                const response = await fetch(`${API_URL}/status`);
                if (!response.ok) {
                    throw new Error('API error');
                }
                const data = await response.json();
                
                const statusElement = document.getElementById('status');
                statusElement.innerHTML = `<p class="text-green-600">${data.message}</p>`;
                alert(data.message);
                
                // If analysis is complete, enable the UI
                if (data.status === 'complete') {
                    // Update UI with cluster data if available
                    if (data.clusters && data.clusters.length > 0) {
                        const clustersDiv = document.getElementById('clusters');
                        clustersDiv.innerHTML = data.clusters.map(cluster => `
                            <div class="border rounded p-4 hover:shadow-lg cursor-pointer transition-shadow" 
                                 onclick="loadArticles(${cluster.cluster_id})">
                                <h3 class="font-semibold">Cluster ${cluster.cluster_id}</h3>
                                <p class="text-sm text-gray-600">Articles: ${cluster.size}</p>
                            </div>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('Error checking status:', error);
                document.getElementById('status').innerHTML = '<p class="text-red-600">Error: API is not responding</p>';
                alert('Error checking status');
            }
        }

        // Handle form submission
        document.getElementById('queryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const query = document.getElementById('query').value;
            const maxResults = document.getElementById('maxResults').value;

            try {
                const button = e.target.querySelector('button');
                button.disabled = true;
                button.textContent = 'Analyzing...';

                const response = await fetch(`${API_URL}/analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query,
                        max_results: parseInt(maxResults)
                    })
                });
                const data = await response.json();
                alert(data.message);

                // Display cluster explanations if available
                if (data.cluster_explanations) {
                    const clustersDiv = document.getElementById('clusters');
                    clustersDiv.innerHTML = data.cluster_explanations.map(cluster => `
                        <div class="border rounded-lg p-6 mb-4 hover:shadow-lg transition-shadow">
                            <h3 class="text-xl font-semibold text-green-800 mb-2">${cluster.title}</h3>
                            <div class="space-y-3">
                                <div>
                                    <p class="font-medium text-gray-700">หัวข้อหลัก:</p>
                                    <p class="text-gray-600">${cluster.main_focus}</p>
                                </div>
                                <div>
                                    <p class="font-medium text-gray-700">คำอธิบาย:</p>
                                    <p class="text-gray-600">${cluster.explanation}</p>
                                </div>
                                <div>
                                    <p class="font-medium text-gray-700">การนำไปใช้:</p>
                                    <p class="text-gray-600">${cluster.practical_use}</p>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }

                const pollInterval = setInterval(async () => {
                    try {
                        await loadClusters();
                        await loadFarmerTopics();
                        clearInterval(pollInterval);
                        button.disabled = false;
                        button.textContent = 'Analyze';
                    } catch (error) {
                        // Continue polling
                    }
                }, 5000);
            } catch (error) {
                console.error('Error starting analysis:', error);
                document.getElementById('status').innerHTML = '<p class="text-red-600">Error: API is not responding</p>';
                alert('Error starting analysis');
            }
        });

        // Load clusters with visualization update
        async function loadClusters() {
            try {
                const response = await fetch(`${API_URL}/clusters`);
                const clusters = await response.json();

                // Update chart data
                topicChart.data.labels = clusters.map(c => `Cluster ${c.cluster_id}`);
                topicChart.data.datasets[0].data = clusters.map(c => c.size);
                topicChart.update();

                const clustersDiv = document.getElementById('clusters');
                clustersDiv.innerHTML = clusters.map(cluster => `
                    <div class="border rounded p-4 hover:shadow-lg cursor-pointer transition-shadow" 
                         onclick="loadArticles(${cluster.cluster_id})">
                        <h3 class="font-semibold">Cluster ${cluster.cluster_id}</h3>
                        <p class="text-sm text-gray-600">Articles: ${cluster.size}</p>
                        <div class="mt-2">
                            ${cluster.common_diseases ? `
                                <p class="text-sm font-medium">Common Diseases:</p>
                                <div class="flex flex-wrap gap-1 mt-1">
                                    ${Object.entries(cluster.common_diseases).slice(0, 5).map(([term, count]) =>
                                        `<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">${term} (${count})</span>`
                                    ).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading clusters:', error);
                document.getElementById('clusters').innerHTML = '<p class="text-red-600">Error loading clusters</p>';
                showToast('Error loading clusters', 'error');
            }
        }

        // Load articles with map markers
        async function loadArticles(clusterId) {
            try {
                const response = await fetch(`${API_URL}/articles/${clusterId}`);
                const articles = await response.json();

                // Clear existing markers
                map.eachLayer((layer) => {
                    if (layer instanceof L.Marker) {
                        map.removeLayer(layer);
                    }
                });

                const articlesDiv = document.getElementById('articles');
                articlesDiv.innerHTML = articles.map(article => `
                    <div class="border rounded-lg p-6 hover:shadow-lg transition-shadow">
                        <h3 class="font-semibold text-lg">${article.Title}</h3>
                        <p class="text-sm text-gray-600">PMID: ${article.PMID}</p>
                        <p class="mt-4 text-gray-700">${article.Abstract}</p>
                        <div class="mt-4 space-y-2">
                            <h4 class="font-medium">Entities:</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                ${Object.entries(article.Entities).map(([key, values]) => `
                                    <div class="bg-gray-50 p-3 rounded">
                                        <p class="font-medium text-sm">${key}:</p>
                                        <p class="text-sm text-gray-600">${values.join(', ')}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ${article.year ? `
                            <div class="mt-4">
                                <p class="text-sm"><span class="font-medium">Year:</span> ${article.year}</p>
                            </div>
                        ` : ''}
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading articles:', error);
                document.getElementById('articlesContainer').innerHTML = '<p class="text-red-600">Error loading articles</p>';
                alert('Error loading articles');
            }
        }

        // Load LDA topics
        async function loadFarmerTopics() {
            try {
                const response = await fetch(`${API_URL}/farmer-topics`);
                const topics = await response.json();

                const topicsDiv = document.getElementById('farmerTopics');
                topicsDiv.innerHTML = topics.map(topic => `
                    <div class="topic-card p-6">
                        <div class="flex items-center gap-4 mb-4">
                            <div class="topic-icon">
                                ${getTopicIcon(topic.topic_id)}
                            </div>
                            <div>
                                <h3 class="font-semibold text-lg text-green-800">${topic.main_focus}</h3>
                                <div class="relevance-bar mt-2">
                                    <div class="relevance-fill" style="width: ${topic.relevance_score}%"></div>
                                </div>
                                <p class="text-sm text-gray-600 mt-1">ความสำคัญ: ${topic.relevance_score}%</p>
                            </div>
                        </div>
                        <p class="text-gray-700 mb-4">${topic.simple_explanation}</p>
                        <div class="flex flex-wrap gap-2">
                            ${topic.key_terms.map(term => `
                                <span class="key-term-tag">${term}</span>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading farmer-friendly topics:', error);
                document.getElementById('farmerTopics').innerHTML = '<p class="text-red-600">Error loading topics</p>';
                alert('Error loading farmer-friendly topics');
            }
        }

        // Helper function to get topic icons
        function getTopicIcon(topicId) {
            const icons = {
                0: '🛡️', // Prevention
                1: '🦠', // Disease and pathogens
                2: '🌾', // Rice management
                3: '🔍', // Disease inspection
                4: '🔬'  // Research and development
            };
            return icons[topicId] || '📋';
        }

        // Add new JavaScript functions for the features
        async function exportData(format) {
            try {
                const response = await fetch(`${API_URL}/export/${format}`);
                if (!response.ok) throw new Error('Export failed');
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `rice_disease_analysis.${format}`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                alert(`Successfully exported data as ${format.toUpperCase()}`);
            } catch (error) {
                alert('Error exporting data');
            }
        }

        let diseaseChart, yearlyChart;

        function initStatisticsCharts() {
            // Initialize Disease Distribution Chart
            const diseaseCtx = document.getElementById('diseaseChart').getContext('2d');
            diseaseChart = new Chart(diseaseCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Disease Occurrences',
                        data: [],
                        backgroundColor: '#4CAF50'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Initialize Yearly Trends Chart
            const yearlyCtx = document.getElementById('yearlyChart').getContext('2d');
            yearlyChart = new Chart(yearlyCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Publications per Year',
                        data: [],
                        borderColor: '#2196F3',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Add this optimization for chart rendering
        function updateChart(chart, labels, data, options = {}) {
            if (!chart) return;
            
            // Only update if data actually changed
            const currentLabels = chart.data.labels || [];
            const currentData = chart.data.datasets[0].data || [];
            
            const labelsChanged = JSON.stringify(currentLabels) !== JSON.stringify(labels);
            const dataChanged = JSON.stringify(currentData) !== JSON.stringify(data);
            
            if (!labelsChanged && !dataChanged) return; // No changes needed
            
            // Update chart data
            chart.data.labels = labels;
            chart.data.datasets[0].data = data;
            
            // Apply any additional options
            if (options.backgroundColor) {
                chart.data.datasets[0].backgroundColor = options.backgroundColor;
            }
            
            if (options.borderColor) {
                chart.data.datasets[0].borderColor = options.borderColor;
            }
            
            // Defer update to next animation frame for better performance
            requestAnimationFrame(() => {
                chart.update('none'); // Use 'none' for faster updates
            });
        }

        // Update your loadStatistics function to use this optimization
        async function loadStatistics() {
            try {
                const data = await fetchWithCache(`${API_URL}/statistics`);

                // Update Disease Chart
                updateChart(
                    diseaseChart,
                    Object.keys(data.disease_counts),
                    Object.values(data.disease_counts)
                );

                // Update Yearly Chart
                const sortedYears = Object.entries(data.yearly_trends)
                    .sort(([a], [b]) => a.localeCompare(b));
                updateChart(
                    yearlyChart,
                    sortedYears.map(([year]) => year),
                    sortedYears.map(([, count]) => count),
                    { borderColor: '#2196F3' }
                );

                // Update Keyword Cloud with optimized DOM operations
                const keywordCloud = getElement('keywordCloud');
                if (keywordCloud) {
                    const fragment = document.createDocumentFragment();
                    const maxCount = Math.max(...data.top_keywords.map(k => k.count));
                    
                    data.top_keywords.forEach(({word, count}) => {
                        const span = document.createElement('span');
                        span.className = 'px-3 py-1 rounded-full text-sm font-medium';
                        span.style.backgroundColor = `rgba(76, 175, 80, ${Math.min(count / maxCount, 0.9)})`;
                        span.textContent = word;
                        fragment.appendChild(span);
                    });
                    
                    // Single DOM update
                    keywordCloud.innerHTML = '';
                    keywordCloud.appendChild(fragment);
                }
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        // Initialize everything
        lazyInitMap();
        initChart();
        initStatisticsCharts();
        checkStatus();
        loadClusters();
        loadFarmerTopics();
        loadCSVData();
        loadStatistics();

        // Add these variables at the top of your script
        let currentPage = 1;
        let totalPages = 1;
        let pageSize = 10;

        // Function to load articles with pagination
        async function loadArticles() {
            try {
                const data = await fetchWithRetry(
                    `${API_URL}/articles?page=${currentPage}&page_size=${pageSize}`
                );
                
                // Update pagination info
                totalPages = data.total_pages;
                currentPage = data.page;
                
                // Update UI
                getElement('pageInfo').textContent = `หน้า ${currentPage} จาก ${totalPages}`;
                getElement('prevPage').disabled = currentPage <= 1;
                getElement('nextPage').disabled = currentPage >= totalPages;
                
                // Display articles
                const container = getElement('articlesContainer');
                if (!container) {
                    console.error('Articles container not found');
                    return;
                }
                
                container.innerHTML = '';
                
                if (!data.items || data.items.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-500 my-4">ไม่พบบทความ</p>';
                    return;
                }
                
                data.items.forEach(article => {
                    try {
                        renderArticle(container, article);
                    } catch (renderError) {
                        console.error('Error rendering article:', renderError);
                        // Add placeholder for failed article
                        const errorElement = document.createElement('div');
                        errorElement.className = 'border-b border-gray-200 pb-6 mb-6 text-red-600';
                        errorElement.textContent = 'ไม่สามารถแสดงบทความนี้ได้';
                        container.appendChild(errorElement);
                    }
                });
            } catch (error) {
                console.error('Error loading articles:', error);
                const container = getElement('articlesContainer');
                if (container) {
                    container.innerHTML = '<p class="text-red-600">Error loading articles</p>';
                }
            }
        }

        // Navigation functions
        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                loadArticles();
            }
        }

        function nextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                loadArticles();
            }
        }

        function changePageSize() {
            pageSize = parseInt(document.getElementById('pageSize').value);
            currentPage = 1;  // Reset to first page
            loadArticles();
        }

        // Load initial articles when page loads
        document.addEventListener('DOMContentLoaded', () => {
            loadArticles();
        });

        // Update the search function to work with pagination
        async function searchArticles() {
            const keyword = document.getElementById('searchKeyword').value;
            const field = document.getElementById('searchField').value;
            
            if (!keyword) {
                alert('Please enter a search keyword');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/search`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ keyword, field })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const articles = await response.json();
                
                // Reset pagination when searching
                currentPage = 1;
                
                // Display results in the articles container
                const container = document.getElementById('articlesContainer');
                
                if (articles.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-500 my-4">No articles found matching your search criteria.</p>';
                    // Update pagination UI for no results
                    document.getElementById('pageInfo').textContent = 'Page 0 of 0';
                    document.getElementById('prevPage').disabled = true;
                    document.getElementById('nextPage').disabled = true;
                    return;
                }
                
                // Display the search results
                container.innerHTML = articles.map(article => `
                    <div class="border-b border-gray-200 pb-6 mb-6 last:border-b-0">
                        <h3 class="text-xl font-semibold text-green-800 mb-2">${article.Title}</h3>
                        <p class="text-gray-600 mb-2">PMID: ${article.PMID} | Cluster: ${article.Cluster}</p>
                        <p class="text-gray-700 mb-4">${article.Abstract}</p>
                        <div class="flex flex-wrap gap-2">
                            ${Object.entries(article.Entities).map(([category, items]) => `
                                <div class="flex flex-col">
                                    <span class="text-sm font-semibold text-green-700">${category}:</span>
                                    <div class="flex flex-wrap gap-1">
                                        ${items.map(item => `
                                            <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">${item}</span>
                                        `).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        ${article.year ? `
                            <div class="mt-2">
                                <span class="text-sm text-gray-600">Year: ${article.year}</span>
                            </div>
                        ` : ''}
                    </div>
                `).join('');
                
                // Show success message
                alert(`Found ${articles.length} matching articles`);
                
            } catch (error) {
                console.error('Error searching articles:', error);
                alert('Error searching articles. Please try again.');
                document.getElementById('articlesContainer').innerHTML = '<p class="text-red-600">Error searching articles</p>';
            }
        }

        // Function to load news articles
        async function loadNews() {
            try {
                const container = document.getElementById('newsContainer');
                if (!container) return;
                
                container.innerHTML = `
                    <div class="col-span-full flex justify-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-green-500"></div>
                    </div>
                `;
                
                const response = await fetch(`${API_URL}/news`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const articles = await response.json();
                
                if (!articles || articles.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-500 col-span-full">ไม่พบข่าวสารล่าสุด</p>';
                    return;
                }
                
                container.innerHTML = articles.map(article => `
                    <div class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow">
                        ${article.urlToImage ? `
                            <img src="${article.urlToImage}" 
                                 alt="${article.title}"
                                 class="w-full h-48 object-cover"
                                 onerror="this.onerror=null; this.src='https://via.placeholder.com/400x200?text=No+Image';">
                        ` : `
                            <div class="w-full h-48 bg-gray-200 flex items-center justify-center">
                                <span class="text-gray-500">No Image Available</span>
                            </div>
                        `}
                        <div class="p-4">
                            <h3 class="text-lg font-semibold text-green-800 mb-2 line-clamp-2">
                                ${article.title || 'Untitled Article'}
                            </h3>
                            <p class="text-gray-600 text-sm mb-3 line-clamp-3">
                                ${article.description || 'No description available'}
                            </p>
                            <div class="flex justify-between items-center">
                                <span class="text-xs text-gray-500">
                                    ${article.publishedAt ? new Date(article.publishedAt).toLocaleDateString() : 'Unknown date'}
                                </span>
                                <a href="${article.url}" 
                                   target="_blank" 
                                   class="text-green-600 hover:text-green-800 text-sm font-medium">
                                    Read More →
                                </a>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading news:', error);
                const container = document.getElementById('newsContainer');
                if (container) {
                    container.innerHTML = '<p class="text-red-600 col-span-full">Error loading news articles. Please try again later.</p>';
                }
            }
        }

        // Add loadNews to the initialization
        document.addEventListener('DOMContentLoaded', () => {
            loadArticles();
            loadNews();  // Add this line
        });

        let currentLanguage = 'th';
        const translationCache = {};

        // Replace the current translation queue system with this improved version
        let translationQueue = [];
        let isProcessingTranslations = false;
        const MAX_CONCURRENT_TRANSLATIONS = 3;
        const activeTranslations = new Set();

        function queueTranslation(element, text, targetLang) {
            // Skip short texts, empty texts, or already translated elements
            if (!text || text.length < 3 || element.hasAttribute('data-translating')) {
                return;
            }
            
            // Set a flag to prevent duplicate queuing
            element.setAttribute('data-translating', 'true');
            
            // Add to queue
            translationQueue.push({ element, text, targetLang });
            
            // Start processing if not already processing
            if (!isProcessingTranslations) {
                processTranslationQueue();
            }
        }

        async function processTranslationQueue() {
            if (translationQueue.length === 0 || activeTranslations.size >= MAX_CONCURRENT_TRANSLATIONS) {
                if (translationQueue.length === 0 && activeTranslations.size === 0) {
                    isProcessingTranslations = false;
                }
                return;
            }
            
            isProcessingTranslations = true;
            
            // Process in batches of 10
            const batch = translationQueue.splice(0, 10);
            const textsToTranslate = batch.map(item => item.text);
            const targetLang = batch[0].targetLang; // Assume same language for batch
            
            // Create a unique ID for this translation request
            const requestId = Date.now().toString(36) + Math.random().toString(36).substr(2);
            activeTranslations.add(requestId);
            
            try {
                const response = await fetch(`${API_URL}/translate-bulk`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        texts: textsToTranslate,
                        target_language: targetLang
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Update elements with translations
                    batch.forEach((item, index) => {
                        if (data.translations && data.translations[index]) {
                            item.element.textContent = data.translations[index].translated_text;
                        }
                        // Remove the translating flag
                        item.element.removeAttribute('data-translating');
                    });
                } else {
                    // Handle API error
                    batch.forEach(item => {
                        item.element.removeAttribute('data-translating');
                    });
                    console.error('Translation API error:', await response.text());
                }
            } catch (error) {
                console.error('Translation batch failed:', error);
                // Remove the translating flag from all elements in this batch
                batch.forEach(item => {
                    item.element.removeAttribute('data-translating');
                });
            } finally {
                activeTranslations.delete(requestId);
            }
            
            // Process next batch with a small delay
            setTimeout(() => {
                processTranslationQueue();
                // Also start new concurrent batches if possible
                if (activeTranslations.size < MAX_CONCURRENT_TRANSLATIONS) {
                    processTranslationQueue();
                }
            }, 50);
        }

        async function changeLanguage(lang) {
            if (currentLanguage === lang) return;
            
            // Update button states
            document.querySelectorAll('.language-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`lang-${lang}`).classList.add('active');
            
            // Show loading message
            const loadingMessage = document.createElement('div');
            loadingMessage.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded shadow-lg z-50';
            loadingMessage.textContent = 'Translating content...';
            document.body.appendChild(loadingMessage);
            
            try {
                // Get all translatable elements
                const elements = document.querySelectorAll('h1, h2, h3, h4, h5, h6, p, span, button, a');
                
                // Clear any existing translation queue
                translationQueue = [];
                
                // Add elements to translation queue
                elements.forEach(element => {
                    const text = element.textContent.trim();
                    if (text && !element.closest('script') && !element.closest('style')) {
                        // Store original text if not already stored
                        if (!element.getAttribute('data-original')) {
                            element.setAttribute('data-original', text);
                        }
                        queueTranslation(element, text, lang);
                    }
                });
                
                // Update current language
                currentLanguage = lang;
                document.documentElement.lang = lang;
                localStorage.setItem('preferredLanguage', lang);
                
                // Update dynamic content
                await Promise.all([
                    loadArticles(),
                    loadClusters(),
                    loadFarmerTopics(),
                    loadStatistics(),
                    loadNews(),
                    loadDiseaseSolutions(),
                    loadClusterSummaries()
                ]);
                
                // Remove loading message and show success message
                document.body.removeChild(loadingMessage);
                const successMessage = document.createElement('div');
                successMessage.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded shadow-lg z-50';
                successMessage.textContent = 'Language changed successfully';
                document.body.appendChild(successMessage);
                setTimeout(() => {
                    document.body.removeChild(successMessage);
                }, 3000);
            } catch (error) {
                console.error('Language change error:', error);
                const errorMessage = document.createElement('div');
                errorMessage.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded shadow-lg z-50';
                errorMessage.textContent = 'Error changing language';
                document.body.appendChild(errorMessage);
                setTimeout(() => {
                    document.body.removeChild(errorMessage);
                }, 3000);
            }
        }

        // Add language persistence
        document.addEventListener('DOMContentLoaded', () => {
            // Load saved language preference
            const savedLanguage = localStorage.getItem('preferredLanguage');
            if (savedLanguage && savedLanguage !== currentLanguage) {
                changeLanguage(savedLanguage);
            }
            
            // Initialize content
            loadArticles();
            loadNews();
        });

        // Update language buttons to save preference
        document.querySelectorAll('.language-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const lang = e.currentTarget.id.replace('lang-', '');
                localStorage.setItem('preferredLanguage', lang);
            });
        });

        // Modify existing functions to support translation
        const originalLoadArticles = loadArticles;
        loadArticles = async function() {
            await originalLoadArticles();
            if (currentLanguage !== 'th') {
                // Translate the loaded articles
                const articles = document.querySelectorAll('#articlesContainer .article');
                for (const article of articles) {
                    const title = article.querySelector('h3');
                    const abstract = article.querySelector('p');
                    
                    if (title && abstract) {
                        title.textContent = await translateText(title.textContent, currentLanguage);
                        abstract.textContent = await translateText(abstract.textContent, currentLanguage);
                    }
                }
            }
        };

        // Similarly modify other loading functions to support translation
        // Add translation support to other dynamic content loading functions as needed

        // Add new function to load disease solutions
        async function loadDiseaseSolutions() {
            try {
                const response = await fetch(`${API_URL}/disease-solutions`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const solutions = await response.json();
                
                const solutionsDiv = document.getElementById('diseaseSolutions');
                solutionsDiv.innerHTML = Object.entries(solutions).map(([disease, info]) => `
                    <div class="border rounded-lg p-6 hover:shadow-lg transition-shadow bg-white">
                        <h3 class="text-xl font-semibold text-green-800 mb-4">${disease}</h3>
                        
                        <div class="mb-4">
                            <h4 class="font-medium text-gray-700 mb-2">อาการ:</h4>
                            <p class="text-gray-600 bg-gray-50 p-3 rounded">${info.symptoms}</p>
                        </div>
                        
                        <div class="mb-4">
                            <h4 class="font-medium text-gray-700 mb-2">วิธีการรักษา:</h4>
                            <ul class="list-none space-y-2">
                                ${info.solutions.map(solution => `
                                    <li class="flex items-start">
                                        <span class="text-green-600 mr-2">•</span>
                                        <span class="text-gray-600">${solution}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                        
                        <div>
                            <h4 class="font-medium text-gray-700 mb-2">การป้องกัน:</h4>
                            <ul class="list-none space-y-2">
                                ${info.prevention.map(prevention => `
                                    <li class="flex items-start">
                                        <span class="text-green-600 mr-2">•</span>
                                        <span class="text-gray-600">${prevention}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading disease solutions:', error);
                document.getElementById('diseaseSolutions').innerHTML = '<p class="text-red-600">Error loading disease solutions</p>';
                alert('Error loading disease solutions');
            }
        }

        // Add loadDiseaseSolutions to initialization
        document.addEventListener('DOMContentLoaded', () => {
            loadArticles();
            loadNews();
            loadDiseaseSolutions();  // Add this line
        });

        // Function to load cluster summaries
        async function loadClusterSummaries() {
            try {
                const response = await fetch(`${API_URL}/cluster-summaries`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const clusterSummariesContainer = document.getElementById('clusterSummaries');
                
                if (!clusterSummariesContainer) {
                    console.error('Cluster summaries container not found');
                    return;
                }
                
                clusterSummariesContainer.innerHTML = data.map(summary => `
                    <div class="bg-white rounded-lg p-4 shadow-md hover:shadow-lg transition-shadow">
                        <h3 class="text-lg font-semibold text-green-800 mb-2">กลุ่ม ${summary.cluster} (${summary.size} บทความ)</h3>
                        
                        ${summary.common_diseases && Object.keys(summary.common_diseases).length > 0 ? `<div class="mb-3">
                            <p class="text-sm font-medium text-gray-600 mb-1">โรคที่พบบ่อย:</p>
                            <div class="flex flex-wrap gap-1">
                                ${Object.entries(summary.common_diseases).slice(0, 5).map(([disease, count]) => `
                                    <span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded">
                                        ${disease} (${count})
                                    </span>
                                `).join('')}
                            </div>
                        </div>` : ''}
                        
                        ${summary.common_treatments && Object.keys(summary.common_treatments).length > 0 ? `<div class="mb-3">
                            <p class="text-sm font-medium text-gray-600 mb-1">วิธีการรักษา:</p>
                            <div class="flex flex-wrap gap-1">
                                ${Object.entries(summary.common_treatments).slice(0, 5).map(([treatment, count]) => `
                                    <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">
                                        ${treatment} (${count})
                                    </span>
                                `).join('')}
                            </div>
                        </div>` : ''}
                        
                        ${summary.common_symptoms && Object.keys(summary.common_symptoms).length > 0 ? `<div class="mb-3">
                            <p class="text-sm font-medium text-gray-600 mb-1">อาการที่พบ:</p>
                            <div class="flex flex-wrap gap-1">
                                ${Object.entries(summary.common_symptoms).slice(0, 5).map(([symptom, count]) => `
                                    <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">
                                        ${symptom} (${count})
                                    </span>
                                `).join('')}
                            </div>
                        </div>` : ''}
                        
                        ${summary.common_effects && Object.keys(summary.common_effects).length > 0 ? `<div>
                            <p class="text-sm font-medium text-gray-600 mb-1">ผลกระทบ:</p>
                            <div class="flex flex-wrap gap-1">
                                ${Object.entries(summary.common_effects).slice(0, 5).map(([effect, count]) => `
                                    <span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded">
                                        ${effect} (${count})
                                    </span>
                                `).join('')}
                            </div>
                        </div>` : ''}
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading cluster summaries:', error);
                const container = document.getElementById('clusterSummaries');
                if (container) {
                    container.innerHTML = '<p class="text-red-600">ไม่สามารถโหลดข้อมูลสรุปกลุ่มได้</p>';
                }
            }
        }

        // Function to analyze rice diseases
        async function analyzeRiceDiseases() {
            try {
                // Show loading state
                const resultsContainer = document.getElementById('riceAnalysisResults');
                resultsContainer.innerHTML = `
                    <div class="flex justify-center items-center py-8">
                        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-green-500"></div>
                        <span class="ml-4 text-gray-600">กำลังวิเคราะห์ข้อมูลโรคข้าว...</span>
                    </div>
                `;

                // Call the API endpoint
                const response = await fetch(`${API_URL}/analyze-rice-diseases`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                // Convert markdown to HTML using marked library
                const summaryHtml = marked.parse(data.Summary);
                
                // Display the results with markdown converted to HTML
                resultsContainer.innerHTML = `
                    <div class="bg-white rounded-lg p-6 shadow-md">
                        <h3 class="text-xl font-semibold text-green-800 mb-4">สรุปการวิเคราะห์</h3>
                        <div class="prose max-w-none text-gray-700 mb-6 markdown-body">
                            ${summaryHtml}
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
                        <div class="bg-white rounded-lg p-6 shadow-md">
                            <h3 class="text-lg font-semibold text-green-800 mb-4">โรคข้าวที่พบบ่อย</h3>
                            <div class="space-y-2">
                                ${data.Collected_Data.diseases_and_impacts.slice(0, 10).map(([disease, count]) => `
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-800">${disease}</span>
                                        <span class="text-green-600 font-medium">${count}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg p-6 shadow-md">
                            <h3 class="text-lg font-semibold text-green-800 mb-4">วิธีการรักษาที่มีประสิทธิภาพ</h3>
                            <div class="space-y-2">
                                ${data.Collected_Data.treatments_and_rates.slice(0, 10).map(([treatment, count]) => `
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-800">${treatment}</span>
                                        <span class="text-green-600 font-medium">${count}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg p-6 shadow-md">
                            <h3 class="text-lg font-semibold text-green-800 mb-4">อาการที่พบบ่อย</h3>
                            <div class="space-y-2">
                                ${data.Collected_Data.symptoms.slice(0, 10).map(([symptom, count]) => `
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-800">${symptom}</span>
                                        <span class="text-green-600 font-medium">${count}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
                
                // Show success message
                alert('วิเคราะห์โรคข้าวเสร็จสมบูรณ์');
                
            } catch (error) {
                console.error('Error analyzing rice diseases:', error);
                document.getElementById('riceAnalysisResults').innerHTML = `
                    <div class="bg-red-50 text-red-600 p-4 rounded-lg">
                        <p class="font-medium">เกิดข้อผิดพลาดในการวิเคราะห์โรคข้าว</p>
                        <p class="text-sm mt-2">${error.message || 'โปรดลองอีกครั้งในภายหลัง'}</p>
                    </div>
                `;
                alert('เกิดข้อผิดพลาดในการวิเคราะห์โรคข้าว');
            }
        }

        // Add event listener for the analyze button
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize UI components
            lazyInitMap();
            initChart();
            initStatisticsCharts();
            
            // Load data
            checkStatus();
            loadClusters();
            loadFarmerTopics();
            loadCSVData();
            loadStatistics();
            loadArticles();
            loadNews();
            loadDiseaseSolutions();
            loadClusterSummaries();
            
            // Add event listeners
            document.getElementById('analyzeRiceDiseases').addEventListener('click', analyzeRiceDiseases);
            document.getElementById('queryForm').addEventListener('submit', handleFormSubmit);
            document.getElementById('searchKeyword').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') searchArticles();
            });
            
            // Load saved language preference
            const savedLanguage = localStorage.getItem('preferredLanguage');
            if (savedLanguage && savedLanguage !== 'th') {
                changeLanguage(savedLanguage);
            }
        });

        // Implement the form submission handler that was previously inline
        async function handleFormSubmit(e) {
            e.preventDefault();
            const query = document.getElementById('query').value;
            const maxResults = document.getElementById('maxResults').value;

            try {
                const button = e.target.querySelector('button');
                button.disabled = true;
                button.textContent = 'Analyzing...';

                const response = await fetch(`${API_URL}/analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query,
                        max_results: parseInt(maxResults)
                    })
                });
                
                // Display results and start polling
                handleAnalysisResponse(response);
                
            } catch (error) {
                console.error('Error starting analysis:', error);
                getElement('status').innerHTML = '<p class="text-red-600">Error: API is not responding</p>';
                alert('Error starting analysis');
            }
        }

        // Add this code after your API_URL declaration
        const API_CACHE = {};

        // Replace the existing fetchWithCache function with this more robust version
        async function fetchWithCache(url, options = {}, cacheDuration = 300000) {
            const cacheKey = url + (options.body ? JSON.stringify(options.body) : '');
            
            // Return cached response if available and not expired
            if (API_CACHE[cacheKey] && (Date.now() - API_CACHE[cacheKey].timestamp < cacheDuration)) {
                return API_CACHE[cacheKey].data;
            }
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 second timeout
                
                const response = await fetch(url, {
                    ...options,
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // Check content type before parsing as JSON
                const contentType = response.headers.get('content-type');
                let data;
                
                if (contentType && contentType.includes('application/json')) {
                    data = await response.json();
                } else if (contentType && contentType.includes('text/csv')) {
                    data = await response.text();
                } else if (options.responseType === 'blob') {
                    data = await response.blob();
                } else {
                    data = await response.text();
                }
                
                // Cache the response
                API_CACHE[cacheKey] = {
                    data: data,
                    timestamp: Date.now()
                };
                
                return data;
            } catch (error) {
                console.error(`Error fetching ${url}:`, error);
                
                // If we have a cached version, return it as fallback even if expired
                if (API_CACHE[cacheKey]) {
                    console.warn(`Using expired cache for ${url}`);
                    return API_CACHE[cacheKey].data;
                }
                
                throw error;
            }
        }

        // Add this utility function for retrying failed API calls
        async function fetchWithRetry(url, options = {}, retries = 3, delay = 1000) {
            try {
                return await fetchWithCache(url, options);
            } catch (error) {
                if (retries <= 1) throw error;
                
                // Wait for the specified delay
                await new Promise(resolve => setTimeout(resolve, delay));
                
                // Retry with one less retry attempt and increased delay
                return fetchWithRetry(url, options, retries - 1, delay * 1.5);
            }
        }

        // Replace scattered DOM query selections with this helper
        const domElements = {};

        function getElement(id) {
            if (!domElements[id]) {
                domElements[id] = document.getElementById(id);
            }
            return domElements[id];
        }

        // Add debounce utility
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    func.apply(this, args);
                }, wait);
            };
        }

        // Debounce the search operations
        const debouncedSearch = debounce(searchArticles, 300);

        // Apply to search input
        document.addEventListener('DOMContentLoaded', () => {
            // ... existing code ...
            
            const searchInput = getElement('searchKeyword');
            if (searchInput) {
                searchInput.addEventListener('input', debouncedSearch);
            }
        });

        // Add this function for toast notifications instead of using alerts
        function showToast(message, type = 'success', duration = 3000) {
            // Remove any existing toasts
            const existingToasts = document.querySelectorAll('.toast-notification');
            existingToasts.forEach(toast => {
                document.body.removeChild(toast);
            });
            
            // Create toast container
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 px-4 py-2 rounded-lg shadow-lg z-50 toast-notification ${
                type === 'success' ? 'bg-green-500 text-white' : 
                type === 'error' ? 'bg-red-500 text-white' : 
                'bg-blue-500 text-white'
            }`;
            
            // Add dismiss button
            toast.innerHTML = `
                <div class="flex items-center">
                    <span>${message}</span>
                    <button class="ml-3 text-white" onclick="this.parentElement.parentElement.remove()">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            `;
            
            // Add to DOM
            document.body.appendChild(toast);
            
            // Remove after duration
            if (duration > 0) {
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, duration);
            }
            
            return toast;
        }

        // Replace all alert() calls with showToast()
        // For example:
        // Instead of: alert('Success message');
        // Use: showToast('Success message', 'success');

        // Instead of: alert('Error message');
        // Use: showToast('Error message', 'error');

        // Add this near the top of your script section to centralize event handling
        const eventHandlers = {
            init() {
                // Page initialization
                this.observeMapVisibility();
                this.observeChartVisibility();
                this.loadInitialData();
                this.setupEventListeners();
                this.loadSavedLanguage();
            },
            
            observeMapVisibility() {
                const mapElement = document.getElementById('map');
                if (!mapElement) return;
                
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            lazyInitMap();
                            observer.disconnect();
                        }
                    });
                }, { threshold: 0.1 });
                
                observer.observe(mapElement);
            },
            
            observeChartVisibility() {
                const chartElements = document.querySelectorAll('.chart-container');
                if (chartElements.length === 0) return;
                
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            lazyInitCharts();
                        }
                    });
                }, { threshold: 0.1 });
                
                chartElements.forEach(el => observer.observe(el));
            },
            
            loadInitialData() {
                checkStatus();
                loadClusters();
                loadFarmerTopics();
                loadCSVData();
                loadStatistics();
                loadArticles();
                loadNews();
                loadDiseaseSolutions();
                loadClusterSummaries();
            },
            
            setupEventListeners() {
                // Form submission
                const queryForm = document.getElementById('queryForm');
                if (queryForm) {
                    queryForm.addEventListener('submit', handleFormSubmit);
                }
                
                // Button clicks
                const analyzeBtn = document.getElementById('analyzeRiceDiseases');
                if (analyzeBtn) {
                    analyzeBtn.addEventListener('click', analyzeRiceDiseases);
                }
                
                // Search input
                const searchInput = document.getElementById('searchKeyword');
                if (searchInput) {
                    searchInput.addEventListener('input', debounce(searchArticles, 300));
                    searchInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') searchArticles();
                    });
                }
                
                // Pagination buttons
                const prevBtn = document.getElementById('prevPage');
                const nextBtn = document.getElementById('nextPage');
                if (prevBtn) prevBtn.addEventListener('click', previousPage);
                if (nextBtn) nextBtn.addEventListener('click', nextPage);
                
                // Page size selector
                const pageSizeSelector = document.getElementById('pageSize');
                if (pageSizeSelector) {
                    pageSizeSelector.addEventListener('change', changePageSize);
                }
                
                // Language buttons
                document.querySelectorAll('.language-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const lang = e.currentTarget.id.replace('lang-', '');
                        changeLanguage(lang);
                    });
                });
            },
            
            loadSavedLanguage() {
                const savedLanguage = localStorage.getItem('preferredLanguage');
                if (savedLanguage && savedLanguage !== 'th') {
                    setTimeout(() => changeLanguage(savedLanguage), 500);
                }
            }
        };

        // Replace multiple DOMContentLoaded listeners with a single one
        document.addEventListener('DOMContentLoaded', () => {
            eventHandlers.init();
        });

        // Add this function to handle network errors gracefully
        function createLoadingPlaceholder(containerId, message = 'กำลังโหลดข้อมูล...') {
            const container = document.getElementById(containerId);
            if (!container) return null;
            
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center p-8 bg-gray-50 rounded-lg animate-pulse">
                    <div class="w-12 h-12 border-4 border-gray-200 border-t-green-500 rounded-full animate-spin mb-4"></div>
                    <p class="text-gray-600">${message}</p>
                </div>
            `;
            
            return container;
        }

        function createErrorPlaceholder(containerId, message = 'เกิดข้อผิดพลาดในการโหลดข้อมูล', retryFn = null) {
            const container = document.getElementById(containerId);
            if (!container) return null;
            
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center p-8 bg-red-50 rounded-lg">
                    <svg class="w-12 h-12 text-red-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                    <p class="text-red-600 text-center mb-4">${message}</p>
                    ${retryFn ? `<button id="retry-${containerId}" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">ลองอีกครั้ง</button>` : ''}
                </div>
            `;
            
            if (retryFn) {
                const retryButton = document.getElementById(`retry-${containerId}`);
                if (retryButton) {
                    retryButton.addEventListener('click', retryFn);
                }
            }
            
            return container;
        }

        // Update one of your data loading functions as an example
        async function loadArticles() {
            try {
                const data = await fetchWithRetry(
                    `${API_URL}/articles?page=${currentPage}&page_size=${pageSize}`
                );
                
                // Update pagination info
                totalPages = data.total_pages;
                currentPage = data.page;
                
                // Update UI
                getElement('pageInfo').textContent = `หน้า ${currentPage} จาก ${totalPages}`;
                getElement('prevPage').disabled = currentPage <= 1;
                getElement('nextPage').disabled = currentPage >= totalPages;
                
                // Display articles
                const container = getElement('articlesContainer');
                if (!container) {
                    console.error('Articles container not found');
                    return;
                }
                
                container.innerHTML = '';
                
                if (!data.items || data.items.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-500 my-4">ไม่พบบทความ</p>';
                    return;
                }
                
                data.items.forEach(article => {
                    try {
                        renderArticle(container, article);
                    } catch (renderError) {
                        console.error('Error rendering article:', renderError);
                        // Add placeholder for failed article
                        const errorElement = document.createElement('div');
                        errorElement.className = 'border-b border-gray-200 pb-6 mb-6 text-red-600';
                        errorElement.textContent = 'ไม่สามารถแสดงบทความนี้ได้';
                        container.appendChild(errorElement);
                    }
                });
            } catch (error) {
                console.error('Error loading articles:', error);
                const container = getElement('articlesContainer');
                if (container) {
                    container.innerHTML = '<p class="text-red-600">Error loading articles</p>';
                }
            }
        }

        // Add intersection observer for lazy loading content
        function setupLazyLoading() {
            const lazyLoadOptions = {
                threshold: 0.1,
                rootMargin: '100px'
            };
            
            // Create a shared IntersectionObserver
            const lazyLoadObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (!entry.isIntersecting) return;
                    
                    const element = entry.target;
                    const dataFunction = element.getAttribute('data-lazy-function');
                    
                    if (dataFunction && typeof window[dataFunction] === 'function') {
                        window[dataFunction](element);
                    }
                    
                    // Unobserve after loading
                    lazyLoadObserver.unobserve(element);
                });
            }, lazyLoadOptions);
            
            // Observe all elements with data-lazy-function attribute
            document.querySelectorAll('[data-lazy-function]').forEach(element => {
                lazyLoadObserver.observe(element);
            });
        }

        // Example of a lazy load function for an element
        function lazyLoadNews(element) {
            createLoadingPlaceholder(element.id);
            loadNews().then(() => {
                console.log('News loaded successfully');
            }).catch(error => {
                console.error('Error lazy loading news:', error);
            });
        }

        // Call this in your init function
        document.addEventListener('DOMContentLoaded', () => {
            // ... other initialization
            setupLazyLoading();
        });

        // Add this to enable basic offline support
        function setupOfflineSupport() {
            // Check if the browser supports service workers
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/service-worker.js').then(registration => {
                        console.log('ServiceWorker registration successful');
                    }).catch(error => {
                        console.error('ServiceWorker registration failed:', error);
                    });
                });
            }
            
            // Listen for online/offline events
            window.addEventListener('online', () => {
                document.body.classList.remove('offline-mode');
                showToast('กลับมาออนไลน์แล้ว กำลังอัพเดทข้อมูล...', 'success');
                eventHandlers.loadInitialData();
            });
            
            window.addEventListener('offline', () => {
                document.body.classList.add('offline-mode');
                showToast('คุณกำลังอยู่ในโหมดออฟไลน์ ข้อมูลอาจไม่อัพเดท', 'warning', 0);
            });
            
            // Check connection status on load
            if (!navigator.onLine) {
                document.body.classList.add('offline-mode');
                showToast('คุณกำลังอยู่ในโหมดออฟไลน์ ข้อมูลอาจไม่อัพเดท', 'warning', 0);
            }
        }

        // Add this call to your initialization
        document.addEventListener('DOMContentLoaded', () => {
            eventHandlers.init();
            setupOfflineSupport();
        });
    </script>
</body>

</html>